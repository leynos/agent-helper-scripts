#!/usr/bin/env bash

HELPER_TOOLS_REPO=${HELPER_TOOLS_REPO:-https://raw.githubusercontent.com/leynos/agent-helper-scripts/refs/heads/main}

if ! grep -q 'PATH=$HOME/.local/bin:$PATH' "${HOME}/.bashrc"; then
  echo 'PATH=$HOME/.local/bin:$PATH' >> "${HOME}/.bashrc"
fi

function needs()
{
  ! which $1 >/dev/null 2>/dev/null
}

if needs uv; then
  curl -LsSf https://astral.sh/uv/install.sh | sh
  if [[ -f "$HOME/.local/bin/env" ]]; then
    source "$HOME/.local/bin/env"
  fi
fi

if needs bun; then
  curl -fsSL https://bun.sh/install | bash
fi

if [[ -d "/usr/local/rustup" ]]; then
  sudo chmod -R go=u "/usr/local/rustup"
fi

if needs rustup; then
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  echo 'PATH=$HOME/.cargo/bin:$PATH' >> "${HOME}/.bashrc"
fi

if needs sudo; then
  # Fingers crossed this works. Systems without sudo will be running as root
  apt-get update -y
  apt-get install -y apt-utils
  apt-get install -y sudo
fi

if needs wget; then
  sudo apt-get update -y
  sudo apt-get install -y apt-utils
  sudo apt-get install -y wget
fi

for tool in \
  get-markdown-tooling \
  get-rust-tooling \
  rust-setup \
  get-github-tooling \
  install-skills; do
    echo "Running $tool..."
    curl -fsSL "${HELPER_TOOLS_REPO}/$tool" | bash -i -xeuo pipefail
done
