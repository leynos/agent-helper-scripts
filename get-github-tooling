if [[ -f "${HOME}/.cargo/env" ]]; then
    . "${HOME}/.cargo/env"
fi

VK_VERSION=${VK_VERSION:-0.5.0}
mkdir -p "${HOME}/.local/bin"
pushd "${HOME}/.local/bin"
wget https://github.com/leynos/vk/releases/download/v${VK_VERSION}/vk
chmod 777 vk
popd

uv tool install mbake
bun install -g pajv

# Tools to help developers
sudo apt-get update -y
sudo apt-get install -y \
  strace gdb \
  bat ripgrep nano ed \
  ltrace valgrind bpfcc-tools bpftrace \
  lsof htop iotop \
  ncdu tree bat delta \
  tcpdump nmap clang lldb \
  eza fzf hyperfine shellcheck \
  linux-tools-common linux-tools-generic

cargo binstall fd-find
cargo binstall mergiraf
cargo binstall difftastic

pwd
cargo binstall leta
leta workspace add .

mkdir -p "${HOME}/.local/bin"
pushd "${HOME}/.local/bin"
CHECKMAKE_VERSION=${CHECKMAKE_VERSION:-0.2.2}
wget -O checkmake https://github.com/checkmake/checkmake/releases/download/${CHECKMAKE_VERSION}/checkmake-${CHECKMAKE_VERSION}.linux.amd64
chmod 755 checkmake
popd

git config --global merge.conflictStyle zdiff3

if ! [[ -f "${HOME}/.gitconfig" ]] || ! grep -q mergiraf "${HOME}/.gitconfig"; then
  cat >>"${HOME}/.gitconfig" <<'__EOF'
[merge "mergiraf"]
        name = mergiraf
        driver = mergiraf merge --git %O %A %B -s %S -x %X -y %Y -p %P -l %L
__EOF
  mkdir -p "${HOME}/.config/git"
  echo "* merge=mergiraf" >> "${HOME}/.config/git/attributes"
fi

(type -p wget >/dev/null || (apt-get update && apt-get install wget -y)) \
	&& sudo mkdir -p -m 755 /etc/apt/keyrings \
	&& out=$(mktemp) && wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg \
	&& cat $out > /dev/null \
	&& sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
	&& sudo mkdir -p -m 755 /etc/apt/sources.list.d \
	&& echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
	&& sudo apt-get update -y \
	&& sudo apt install gh -y

gh extension install https://github.com/nektos/gh-act

cargo binstall action-validator

echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
sudo apt-get update -y
sudo apt-get install -y nfpm podman bubblewrap proot mmdebstrap
