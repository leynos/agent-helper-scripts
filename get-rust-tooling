case ":${PATH}:" in
    *:"${HOME}/.local/bin":*)
        ;;
    *)
        export PATH="${HOME}/.local/bin:$PATH"
        ;;
esac

# Rust tooling
if [[ -n "${RUST_CHANNEL:-}" ]]; then
  channel=${RUST_CHANNEL}
elif [[ -f "rust-toolchain.toml" ]]; then
  channel=$(uv run -p 3.13 python -c 'import tomllib; print(tomllib.loads(open("rust-toolchain.toml", "r").read())["toolchain"]["channel"])')
else
  channel=stable
fi

sudo apt-get update -y
sudo apt-get install -y build-essential pkg-config libssl-dev ca-certificates libpq-dev libsqlite3-dev
sudo update-ca-certificates

WITH_LLVM_COV=${WITH_LLVM_COV:-1}
if ! which rustup >/dev/null 2>&1; then
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
fi
curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

rustup toolchain install "${channel}"
if [[ -f "${HOME}/.cargo/env" ]]; then
   cat >${HOME}/.cargo/env <<'_EOF'
case ":${PATH}:" in
    *:"$CARGO_HOME/bin":*)
        ;;
    *)
        export PATH="$CARGO_HOME/bin:$PATH"
        ;;
esac
__EOF
    . "${HOME}/.cargo/env"
fi
rustup component add rustfmt --toolchain "${channel}"
rustup component add clippy --toolchain "${channel}"
if ((WITH_LLVM_COV)); then
  cargo binstall --no-confirm cargo-llvm-cov
  rustup component add llvm-tools-preview --toolchain "${channel}"
fi
rustup component add rust-analyzer --toolchain "${channel}"

cargo binstall --no-confirm cargo-nextest

if [[ -n "${SCCACHE_BUCKET:-}" ]] || [[ -n "${SCCACHE_WEBDAV_ENDPOINT:-}" ]]; then
  cargo binstall --no-confirm sccache
  echo 'export RUSTC_WRAPPER="$(command -v sccache)"' >> ~/.bashrc
fi

cargo install whitaker-installer
whitaker-installer --experimental
